<!-- npx tailwindcss -i ./src/css/styles.css -o ./dist/output.css --watch -->
<!-- to watch for changes in all the files in the src folder including js and all html files-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>home</title>
    <link href="../dist/output.css" rel="stylesheet">
</head>
<body class="h-screen w-full min-w-[350px] min-h-[350px] bg-red-300">
  <!-- fixed the min h and w based on window resizing and content fit -->
    <header class="w-full fixed top-0 bg-green-200 h-[10vh] xl:h-[15vh] z-20">
      <!-- in the above header i had to put z-200 for the mobile-menu to overlay on the rest of the body to be visible -->
        <div class="flex w-full md:w-[90%] h-full mx-auto">
            <div class="flex w-2/3 md:w-1/2 justify-left sm:justify-left ml-4 md:ml-0 items-center">
                <img src="assets/Unknown.jpeg" alt="logo" class="h-1/2">
                <h1 class="font-bold text-gray-800 text-[clamp(0.5rem,1.5rem,10vh)] md:text-3xl lg:text-4xl leading-none">Green Frames</h1> <!--added leading-none to make the text fit inside header for devices as small as apple watch se 40 mm -->
            </div>
            <!-- nav bar for large screens -->
            <nav class="hidden md:flex flex-row w-1/2 h-1/2 mx-auto justify-evenly items-end my-auto">
                <a href="#" class="hover:text-gray-400 text-center p-1 w-1/6 h-auto">Home</a>
                <a href="#" class="hover:text-gray-400 text-center p-1 w-1/6 h-auto">About</a>
                <a href="#" class="hover:text-gray-400 text-center p-1 w-1/6 h-auto">Gallery</a>
                <a href="#" class="hover:text-gray-400 text-center p-1 w-1/6 h-auto">Contact</a>
            </nav>
            <div class="md:hidden relative my-auto flex w-1/3 justify-end h-1/2">
              <!-- the below <p> makes the button unclickable between to complete the animations -->
            <p id="overlay" class="md:hidden block absolute top-0 left-auto mr-4 w-12 h-full z-0"></p>
            <button id="menu-toggle" class="md:hidden my-auto mr-4 h-full w-12 text-[clamp(0.25rem,1rem,5vh)] leading-[5vh]">|||</button> <!--text-[clamp(0.25rem,1rem,5vh)] leading-[5vh] set these temporarily to make the text inside responsive to vertical resizing, don't need this if not using text-->
          </div>
              <!-- nav bar for smaller screens -->
              <nav id="mobile-menu" class="hidden flex flex-col absolute top-[10vh] right-0 bg-green-200 p-4 w-48 shadow-lg overflow-hidden">
              <!--elements to make the bricks broken-fall effect -->
              <a href="#" class="menu-item block px-4 py-2 bg-green-700 opacity-0 transform translate-x-full transition-all duration-300">Home</a>
                <a href="#" class="menu-item block px-4 py-2 bg-green-700 opacity-0 transform translate-x-full transition-all duration-500">About</a>
                <a href="#" class="menu-item block px-4 py-2 bg-green-700 opacity-0 transform translate-x-full transition-all duration-700">Gallery</a>
                <a href="#" class="menu-item block px-4 py-2 bg-green-700 opacity-0 transform translate-x-full transition-all duration-900">Contact</a>
              <!-- to make the bricks falls one after the other -->
                <!-- <a class="menu-item transform translate-x-full transition-all ease-linear duration-500 block px-4 py-2 bg-green-700 opacity-0">Home</a>
                <a class="menu-item transform translate-x-full transition-all ease-linear duration-500 block px-4 py-2 bg-green-700 opacity-0">Home</a>
                <a class="menu-item transform translate-x-full transition-all ease-linear duration-500 block px-4 py-2 bg-green-700 opacity-0">Home</a>
                <a class="menu-item transform translate-x-full transition-all ease-linear duration-500 block px-4 py-2 bg-green-700 opacity-0">Home</a> -->

              </nav>
              <script>
                // //to make the bricks broken-fall effect
                document.getElementById("menu-toggle").addEventListener("click", function() {
                  document.getElementById("overlay").classList.replace("z-0", "z-20");
                  let menu = document.getElementById("mobile-menu");
                  let menuItems = document.querySelectorAll(".menu-item");
              
                  if (menu.classList.contains("hidden")) {
                    menu.classList.remove("hidden");
                    setTimeout(() => {
                      menuItems.forEach((item, index) => {
                        setTimeout(() => {
                          item.classList.remove("opacity-0", "translate-x-full");
                        }, index * 100);
                      });
                    }, 10);

                    // Home ‚Üí 0ms delay 300ms duration
                    // About ‚Üí 100ms delay 500ms duration
                    // Gallery ‚Üí 200ms delay 700ms duration
                    // Contact ‚Üí 300ms delay 900ms duration
                  } else {
                    menuItems.forEach((item, index) => {
                      setTimeout(() => {
                        item.classList.add("opacity-0", "translate-x-full");
                      }, (menuItems.length - index - 1) * 100);
                    });
              
                    setTimeout(() => {
                      menu.classList.add("hidden");
                    }, 500);
                  }
                  setTimeout(() => {
                    document.getElementById("overlay").classList.replace("z-20", "z-0");
                  }, 700);
                });

              //to make the bricks falls one after the other
              // document.getElementById("menu-toggle").addEventListener("click", function() {
              //     document.getElementById("overlay").classList.replace("z-0", "z-20");
              //     let menu = document.getElementById("mobile-menu");
              //     let menuItems = document.querySelectorAll(".menu-item");
              
              //     if (menu.classList.contains("hidden")) {
              //       menu.classList.remove("hidden");
              //       setTimeout(() => {
              //         menuItems.forEach((item, index) => {
              //           setTimeout(() => {
              //             item.classList.remove("opacity-0", "translate-x-full");
              //           }, index * 250);
              //         });
              //       }, 10);
              //     } else {
              //       menuItems.forEach((item, index) => {
              //         setTimeout(() => {
              //           item.classList.add("opacity-0", "translate-x-full");
              //         }, (menuItems.length - index - 1) * 100);
              //       });
              
              //       setTimeout(() => {
              //         menu.classList.add("hidden");
              //       }, 500);
              //     }
              //     setTimeout(() => {
              //       document.getElementById("overlay").classList.replace("z-20", "z-0");
              //     }, 1000);
              //   });
              </script>
              

        </div>
    </header>

    <nav id="internal-nav" class="w-[90%] max-sm:w-full flex flex-row fixed max-sm:bottom-0 sm:top-[10vh] xl:top-[15vh] h-[5vh] max-sm:mx-0 items-center mx-[5%] z-20">
      <!-- had to mention "max-sm:flex max-sm:items-center max-sm:justify-center" to make the items centered vertically in 100% cases  -->
        <a href="#" class="hover:text-gray-400 sm:h-3/4 max-sm:h-full flex items-center justify-center w-28 max-sm:flex-1 text-center bg-green-50 box-border border-2 border-green-200 text-[clamp(.5rem,1rem,5vh)]">All</a>
        <a href="#" class="hover:text-gray-400 sm:h-3/4 max-sm:h-full flex items-center justify-center w-28 max-sm:flex-1 text-center bg-green-50 box-border border-2 border-green-200 text-[clamp(.5rem,1rem,5vh)]">Flora</a>
        <a href="#" class="hover:text-gray-400 sm:h-3/4 max-sm:h-full flex items-center justify-center w-28 max-sm:flex-1 text-center bg-green-50 box-border border-2 border-green-200 text-[clamp(.5rem,1rem,5vh)]">Fauna</a>
    </nav>

<div id="wrapper" class="h-screen w-full  snap-y snap-mandatory overflow-y-scroll">
    
     
    <div id="bottom-7.5vh" class="hidden fixed bottom-0 left-0 z-30 h-[7.5vh] flex w-full justify-around items-center bg-slate-500 transition-all duration-1000 ease-in-out  opacity-0"><!--xl:bottom-[15vh] xl:w-[32vw] xl:left-[58%] for ipad screen rotation scenario, after completing the layout for desktop carousel decide on this! can make the element xl:absolute but add 100vh from bottom to accomodate for the prepared for next post scenario-->
        <button id="go-back" class="border-2 border-white">Go Back</button>
        <button id="" class="border-2 border-white w-1/2">Donate</button>
      </div>
</div>       

    <footer class="hidden md:flex fixed w-full bottom-0 bg-green-200 h-[5vh] z-20">
        <div class="w-[90%] h-full mx-auto flex">
        <div class="w-1/2 flex h-full justify-center items-center">
          <a id="prev-post" href="#" class="m-4 text-[clamp(.5rem,1rem,5vh)]">prev ^</a>
          <a id="next-post" href="#" class="m-4 text-[clamp(.5rem,1rem,5vh)]">next v</a>
        </div>
        <div class="w-1/2 flex h-full justify-center items-center">
            <a href="#" class="m-4">I</a>
            <a href="#" class="m-4">F</a>
            <a href="#" class="m-4">W</a>
        </div>
        </div>
    </footer>
<div id="tailwind-safelist-dummy" class="hidden snap-start -translate-x-full translate-x-0 z-0 z-10 z-20"></div>

<!-- <div class="h-screen overflow-y-scroll snap-y snap-mandatory">
    <section class="h-screen bg-red-300 snap-start"></section>
    <section class="h-screen bg-green-300 snap-start"></section>
    <section class="h-screen bg-blue-300 snap-start"></section>
  </div> -->
  

</body>
<script>

// Animation state for intro screen
let animationDone = false;
const allposts = [];
let generatePostHTML; // global
const wrapper = document.getElementById("wrapper");
// Lazy loading tracking state
let maxLoadedIndex = -1;// total number of loaded posts in memory
let currentPost=0;
let previousPost=-1;
let killProgressiveLoad = false;
let viewed =[];

async function fetchGalleryPosts() {
const cloudName = "dumtyosqg";
const tag = "gallery";
const url = `https://res.cloudinary.com/${cloudName}/image/list/${tag}.json`;

try {
  const res = await fetch(url);
  if (!res.ok) throw new Error("Failed to fetch JSON");

  const data = await res.json();
  const resources = data.resources || [];

  const filteredPosts = resources
    .filter(asset => asset.asset_folder === "gallery")
    .map(asset => {
      const ctx = asset.context?.custom || {};
      return {
        id: asset.public_id,
        assetId: asset.asset_id,
        url: asset.secure_url,
        caption: ctx.caption || "",
        alt: ctx.alt || "",
        atrocities: ctx.atrocities || "",
        facts: ctx.facts || "",
        atTheMoment: ctx["at-the-moment"] || ctx["moment"] || "",
        donation: ctx.donation || "",
        photographer: ctx["photographer-name"] || ctx.photographer || "",
        social: ctx["photographer-link"] || ctx.social || "",
        approved: ctx.approved ?? "true", // <-- fallback if not present
        createdAt: asset.created_at,
        tags: asset.tags || []
      };
    });

  allposts.push(...filteredPosts);
  console.log(`[‚úÖ Total Posts Loaded: ${allposts.length}]`, allposts);
} catch (err) {
  console.error("‚ùå Error fetching gallery:", err);
}
}

function generateMobilePost(post, index) {
return `<div data-index="${index}" class="main w-full flex flex-col h-screen  max-sm:pt-[5vh] sm:pt-[15vh] md:pt-[14vh] xl:pt-[19vh] snap-start snap-always">  
<div class="post-card w-[80%] h-[70vh] flex flex-row justify-center items-center mx-auto my-auto">
  <div class="image-side w-full  bg-black relative h-full flex flex-col justify-center items-center">
    <a href="#" class="PhotographerId block w-full absolute bottom-[100%] text-center text-[clamp(.5rem,1rem,3.75vh)] leading-[4vh] bg-green-200 h-[4vh]">By: ${post.photographer}</a>
      <div class="image-container max-md:h-[60vh] md:h-[63.5vh] absolute top-0 transition-all duration-700 ease-in-out w-full">
        <img src="https://res.cloudinary.com/dumtyosqg/image/upload/${post.id}" loading="lazy" alt="something went wrong!" class="h-full w-auto max-w-full object-contain mx-auto">
      </div>
  <div class="carousel-preview max-md:h-[10vh] h-[6.5vh] bg-green-200 absolute max-md:top-[60vh] md:top-[63.5vh] transition-all duration-700 ease-in-out w-full">
      <div class="just-a-wrapper h-full w-full px-2 py-[1vh] md:pb-0 flex flex-col">
      <p class="text-gray-700 max-md:line-clamp-2 md:line-clamp-1 overflow-hidden text-[clamp(.25rem,1rem,2.5vh)] leading-[2.5vh]">
        <span class="font-bold">At the Moment: </span><span>${post.atTheMoment}</span>
      </p>
      <a class="read-more-link text-blue-400 text-[clamp(.05rem,1rem,2.5vh)] h-[3vh]">Full info</a>
      </div>
  </div>
    <div class="social-icons hidden max-md:flex w-full absolute top-[100%] justify-evenly items-center h-[4vh]">
      <a href="#" class="">I</a>
      <a href="#" class="">F</a>
      <a href="#" class="">W</a>
    </div>
  </div>
</div>
</div>`;
}

function generateDesktopPost(post, index) {
return `<div data-index="${index}" data-animated="false" class="main w-full flex flex-col h-screen pt-[15vh] snap-start snap-always min-w-[950px]">
      
  
<div class="post-card w-[80%] h-[65vh] flex flex-row justify-center items-center mx-auto my-auto">

  <div class="image-side w-[60%] bg-black relative h-full flex flex-col justify-center items-center z-10">
      <a href="#" class="PhotographerIdxl-placeholder block invisible h-[2.5vh]"></a>
      <div class="image-container h-[60vh]">
        <img src="https://res.cloudinary.com/dumtyosqg/image/upload/${post.id}" loading="lazy" alt="something went wrong!" class="h-full w-auto max-w-full object-contain mx-auto">
      </div>
      <a href="#" class="PhotographerIdxl block w-full text-white text-center h-[2.5vh] text-[1.5vh] leading-[2.5vh]">By: ${post.photographer}</a>
  </div>

  <div class="info-side w-[40%] flex flex-col bg-green-300 h-full ${viewed.includes(index)?"":"-translate-x-full opacity-0 transition-all duration-700 ease-in-out"}">

    <div class="info-carousel w-full h-[85%] relative overflow-hidden transition-all duration-700 ease-in-out">
       <div class="carousel-container w-full h-full flex transition-transform duration-500 ease-in-out ">
        <div class="first-slide carousel-slide min-w-full max-h-full px-6 flex flex-col bg-slate-300">
          <div class="slide1-content min-h-[18vh] max-h-full"> 
            <div class="font-bold h-[7.5vh]  text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>At The Moment</span></div>
            <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">${post.atTheMoment}</p>
          </div>
          <div class="flex-auto bg-black"></div> 
        </div>
  
        <div class="second-slide carousel-slide min-w-full max-h-full px-6 flex flex-col bg-slate-300">
          <div class="slide2-content min-h-[18vh] max-h-full"> 
            <div class="font-bold h-[7.5vh]  text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>Facts</span></div>
            
            <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">${post.facts}</p>
          </div>
          <div class="flex-auto bg-black"></div> 
        </div>
  
        <div class="third-slide carousel-slide min-w-full max-h-full px-6 flex flex-col bg-slate-300">
          <div class="slide3-content min-h-[18vh] max-h-full"> 
            <div class="font-bold h-[7.5vh]  text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>Atrocities</span></div><!--made 7vh highest size for the text below to not overlay on this no matter how small the window is resized-->
            
            <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">${post.atrocities}</p>
          </div>
          <div class="flex-auto bg-black"></div> 
        </div>
  
    </div>
    <button class="prev-slide absolute h-[5vh] left-2 top-[2.5vh] transform -translate-y-1/2 bg-slate-300 text-white  rounded-full focus:outline-none">‚Üê</button>
    <button class="next-slide absolute h-[5vh] right-2 top-[2.5vh] transform -translate-y-1/2 bg-slate-400 text-white  rounded-full focus:outline-none">‚Üí</button>
  </div>

  <div class="button-section h-[15%] flex justify-center items-center">
    <button class="donate-button border-2 border-green-500 px-3 h-1/2 w-1/3 text-center text-lg">Donate</button>
  </div>

  </div>
</div>

    
</div>`;
}
const isMobile = window.innerWidth < 1280;


// Start app: Show animation, fetch posts, and manage visibility
async function startAppFlow() {
  showLoadingAnimation();

  generatePostHTML = isMobile ? generateMobilePost : generateDesktopPost;
  await fetchGalleryPosts();
  fetchPosts(0, 4, null, () => observePostNavigation()); // Lazy load posts 0‚Äì4 initially

  // Always hide the animation screen after exactly 5 seconds
  setTimeout(() => {
    hideLoadingAnimation();
  }, 2000);
}

// Show full-screen animation overlay (optional element to add visually)
function showLoadingAnimation() {
  console.log("‚è≥ Showing 5-sec animation screen...");
  // You can make a loading screen visible here (e.g., remove hidden class)
}

// Hide full-screen animation overlay
function hideLoadingAnimation() {
  console.log("‚úÖ Hiding animation screen");
  animationDone = true;
  // You can hide the loading screen here (e.g., add hidden class)
}

// Fetch and render a set of posts from index `start` to `end`
function fetchPosts(start, end, currentpostat=null, resolve = () => {}, reject = () => {}) {
console.log(`üì¶ Trying to Fetch posts from ${start} to ${end}`);

for (let i = start; i <= end && i < allposts.length; i++) {
  if (currentpostat != null && currentpostat > currentPost) {
    console.log(`‚õî Aborting fetch: currentpostat (${currentpostat}) > currentpost (${currentPost})`);
    reject("Aborted fetch due to scroll back");
    return;
  }

  if(!wrapper.children[i+1]){/* i+1 because the first child is bottom-7.5vh, checking if the post exists before creating it*/
  const postHTML = generatePostHTML(allposts[i], i);
  wrapper.insertAdjacentHTML("beforeend", postHTML);
  if (i > maxLoadedIndex) maxLoadedIndex = i;

  const newPost = document.querySelector(`.main[data-index="${i}"]`);
  if (newPost && postObserver) {
    postObserver.observe(newPost);
    console.log(`üì° Observing new post ${i}`);
  }
}
else{
  console.log(`Post ${i} already exists`);
}
}

resolve(); // done loading
}



let postObserver = null;


// Observer to track currently visible post and trigger logic
function observePostNavigation() {

  postObserver = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        const currentPostAt = parseInt(entry.target.getAttribute("data-index"));
        if (currentPostAt !== currentPost) {
          console.log(`üëÄ Viewing Post: ${currentPostAt}`);
          previousPost= currentPost;
          currentPost = currentPostAt;
                if (!isMobile) {
                  initializeCarousel(entry.target);
                  console.log("inside if block");
                }else{
                  setupReadMoreListener(entry.target); 
                }
        }
                  if (entry.target.dataset.animated === "false") {
            setTimeout(() => {
                const info_side = entry.target.querySelector(".info-side"); // ‚¨ÖÔ∏è Add the dot (important)
                if (info_side) {
                  info_side.classList.remove("-translate-x-full","opacity-0");
                  info_side.classList.add("translate-x-0","opacity-100");
                  entry.target.dataset.animated = "true";
                  console.log(`üéûÔ∏è Animated post ${currentPostAt}`);
                }
            }, 500); // You chose 500ms delay here
          }
          viewed.push(currentPostAt);//to keep track of viewed posts so far no matter the order of navigation, or regenrated posts, its used for animating carousel for desktop
                  console.log(viewed);//you can also use viewed array to keep track of user navigation sequence.

          if((currentPostAt - 2) % 5 === 0 && maxLoadedIndex>=currentPostAt+3 && previousPost>currentPostAt){
            fillEmptyPosts(currentPostAt)
            .then(() =>removeFarPosts(currentPostAt)) // clean up phase (empty for now)
            .then(() => {
              console.log("‚úÖ Finished filling empty containers & removing far posts ");
            })
            .catch(err => {
              console.warn(`‚ö†Ô∏è Skipped or aborted at post ${currentPostAt}:`, err);
            });
          }else if((currentPostAt - 3) % 5 === 0&& previousPost<currentPostAt) {
          lazyLoadFuturePosts(currentPostAt)
            .then(() => {if(currentPostAt>3)removeOldPosts(currentPostAt)}) // clean up phase (empty for now)
            .then(() => {
              console.log(`‚úÖ Finished loading & cleanup for post ${currentPostAt}`);
            })
            .catch(err => {
              console.warn(`‚ö†Ô∏è Skipped or aborted at post ${currentPostAt}:`, err);
            });
        }


      }
    });
  }, {
    root: wrapper,
    threshold: 0.6
  });

  // Initial observe for first 5 posts
  document.querySelectorAll('.main').forEach(post => postObserver.observe(post));
  const firstPost = document.querySelector('.main[data-index="0"]');
if (firstPost && !isMobile) {
  initializeCarousel(firstPost);
}else if(firstPost){
  setupReadMoreListener(firstPost);
}

}
  
function fillEmptyPosts(currentpostat) {
  return new Promise((resolve, reject) => {
    if (currentpostat <= 2) {
      console.log("‚ÑπÔ∏è Skipping fill: currentpostat <= 2");
      resolve();
      return;
    }
    const from = currentpostat - 3;
    const to = currentpostat - 7;

    for (let i = from; i >= to && i >= 0; i--) {
      if (currentPost > currentpostat) {
        console.log("‚õî Aborted fill: user navigated away");
        reject("User navigated away during fill");
        return;
      }

      const container = document.querySelector(`.main[data-index='${i}']`);
      if (container && container.children.length === 0 && allposts[i]) {
        const post = allposts[i];

        const innerHTML = isMobile
          ? `
            <div class="post-card w-[80%] h-[70vh] flex flex-row justify-center items-center mx-auto my-auto">
              <div class="image-side w-full bg-black relative h-full flex flex-col justify-center items-center">
                <a href="#" class="PhotographerId block w-full absolute bottom-[100%] text-center text-[clamp(.5rem,1rem,3.75vh)] leading-[4vh] bg-green-200 h-[4vh]">By: ${post.photographer}</a>
                <div class="image-container max-md:h-[60vh] md:h-[63.5vh] absolute top-0 transition-all duration-700 ease-in-out border-2 border-white">
                  <img src="https://res.cloudinary.com/dumtyosqg/image/upload/${post.id}" loading="lazy" alt="something went wrong!" class="h-full w-auto max-w-full object-contain mx-auto">
                </div>
                <div class="carousel-preview max-md:h-[10vh] h-[6.5vh] bg-green-200 absolute max-md:top-[60vh] md:top-[63.5vh] transition-all duration-700 ease-in-out w-full">
                  <div class="just-a-wrapper h-full w-full px-2 py-[1vh] md:pb-0 flex flex-col">
                    <p class="text-gray-700 max-md:line-clamp-2 md:line-clamp-1 overflow-hidden text-[clamp(.25rem,1rem,2.5vh)] leading-[2.5vh]">
                      <span class="font-bold">At the Moment: </span><span>${post.atTheMoment}</span>
                    </p>
                    <a class="read-more-link text-blue-400 text-[clamp(.05rem,1rem,2.5vh)] h-[3vh]">Full info</a>
                  </div>
                </div>
                <div class="social-icons hidden max-md:flex w-full absolute top-[100%] justify-evenly items-center h-[4vh]">
                  <a href="#">I</a>
                  <a href="#">F</a>
                  <a href="#">W</a>
                </div>
              </div>
            </div>`
          : `
            <div class="post-card w-[80%] h-[65vh] flex flex-row justify-center items-center mx-auto my-auto">
              <div class="image-side w-[60%] bg-black relative h-full flex flex-col justify-center items-center">
                <a href="#" class="PhotographerIdxl-placeholder block invisible h-[2.5vh]"></a>
                <div class="image-container h-[60vh]">
                  <img src="https://res.cloudinary.com/dumtyosqg/image/upload/${post.id}" loading="lazy" alt="something went wrong!" class="h-full w-auto max-w-full object-contain mx-auto">
                </div>
                <a href="#" class="PhotographerIdxl block w-full text-white text-center h-[2.5vh] text-[1.5vh] leading-[2.5vh]">By: ${post.photographer}</a>
              </div>
              <div class="info-side w-[40%] flex flex-col bg-green-300 h-full">
                <div class="info-carousel w-full h-[85%] relative overflow-hidden transition-all duration-700 ease-in-out">
                  <div class="carousel-container w-full h-full flex transition-transform duration-500 ease-in-out">
                    <div class="first-slide carousel-slide min-w-full max-h-full px-6 flex flex-col bg-slate-300">
                      <div class="slide1-content min-h-[18vh] max-h-full">
                        <div class="font-bold h-[7.5vh] text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>At The Moment</span></div>
                        <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">${post.atTheMoment}</p>
                      </div>
                      <div class="flex-auto bg-black"></div>
                    </div>
                    <div class="second-slide carousel-slide min-w-full max-h-full px-6 flex flex-col bg-slate-300">
                      <div class="slide2-content min-h-[18vh] max-h-full">
                        <div class="font-bold h-[7.5vh] text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>Facts</span></div>
                        <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">${post.facts}</p>
                      </div>
                      <div class="flex-auto bg-black"></div>
                    </div>
                    <div class="third-slide carousel-slide min-w-full max-h-full px-6 flex flex-col bg-slate-300">
                      <div class="slide3-content min-h-[18vh] max-h-full">
                        <div class="font-bold h-[7.5vh] text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>Atrocities</span></div>
                        <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">${post.atrocities}</p>
                      </div>
                      <div class="flex-auto bg-black"></div>
                    </div>
                  </div>
                  <button class="prev-slide absolute h-[5vh] left-2 top-[2.5vh] transform -translate-y-1/2 bg-slate-300 text-white rounded-full focus:outline-none">‚Üê</button>
                  <button class="next-slide absolute h-[5vh] right-2 top-[2.5vh] transform -translate-y-1/2 bg-slate-400 text-white rounded-full focus:outline-none">‚Üí</button>
                </div>
                <div class="button-section h-[15%] flex justify-center items-center">
                  <button class="donate-button border-2 border-green-500 px-3 h-1/2 w-1/3 text-center text-lg">Donate</button>
                </div>
              </div>
            </div>`;

        container.innerHTML = innerHTML;
        console.log(`üß© Refilled content into post container ${i}`);
      }
    }

    resolve();
  });
}
function removeFarPosts(currentpostat) {
  console.log(`üßπ removeFarPosts(): trying to remove posts from ${maxLoadedIndex} to ${currentpostat + 7}`);
  
  for (let i = maxLoadedIndex; i >= currentpostat + 3; i--) {
    if (currentPost < currentpostat) {
      console.warn(`‚õî Abort removal: user went back to post ${currentPost}`);
      return;
    }

    const el = document.querySelector(`.main[data-index='${i}']`);
    if (el) {
      el.remove();
      console.log(`üóëÔ∏è Removed post container ${i}`);
    } else {
      console.log(`‚ö†Ô∏è Skipped: post container ${i} not found`);
    }
  }

  // Update maxLoadedIndex
  maxLoadedIndex = wrapper.children.length-1;//length -1 to account for the bottom-7.5vh
  console.log(`üîÑ maxLoadedIndex now updated to ${maxLoadedIndex}`);
}


function lazyLoadFuturePosts(currentpostat) {
return new Promise((resolve, reject) => {
  // if(previousPost<currentpostat){
    fetchPosts(currentpostat + 2, currentpostat + 6, currentpostat, resolve, reject);
  // }else{resolve()}
});
}
function removeOldPosts(currentpostat) {
let i = 0;
const limit = currentpostat - 3;

function runCleanupStep() {
  if (currentpostat > currentPost) {
    console.log("‚õî Aborted cleanup: user went back");
    return;
  }

  if (i >= limit) {
    console.log("‚úÖ Finished cleanup.");
    return;
  }

  clearPostChildren(i);
  console.log(`üßπ Cleanup: ${i}th post is removed from container`);
  i++;

  setTimeout(runCleanupStep, 1000);
}

runCleanupStep();
}






// üîÅ Begin the application logic
startAppFlow();

document.getElementById("next-post").addEventListener("click", () => {
    wrapper.scrollBy({ top: window.innerHeight, behavior: "smooth" });
  });

  document.getElementById("prev-post").addEventListener("click", () => {
    wrapper.scrollBy({ top: -window.innerHeight, behavior: "smooth" });
  });


//to use in console for testing post removal from container
function clearPostChildren(index) {
  const el = document.querySelector(`.main[data-index='${index}']`);
  if (el) {
    console.log(`üßº Clearing children of post ${index}`);
    el.innerHTML = "";
    // clearedPosts.add(index);
  } else {
    console.warn(`‚ö†Ô∏è Post ${index} not found in DOM`);
  }
}

let activeCarousel = null;

function initializeCarousel(postInView) {
  let currentSlide = 0;
  const slides = postInView.querySelectorAll(".carousel-slide");
  const totalSlides = slides.length;
  const carouselContainer = postInView.querySelector(".carousel-container");
  const prevBtn = postInView.querySelector(".prev-slide");
  const nextBtn = postInView.querySelector(".next-slide");

  activeCarousel = { currentSlide, slides, totalSlides, carouselContainer };

  function updateCarousel() {
    activeCarousel.carouselContainer.style.transform = `translateX(-${activeCarousel.currentSlide * 100}%)`;
    prevBtn.classList.toggle("bg-slate-400", activeCarousel.currentSlide > 0);
    prevBtn.classList.toggle("bg-slate-300", activeCarousel.currentSlide === 0);
    nextBtn.classList.toggle("bg-slate-400", activeCarousel.currentSlide < activeCarousel.totalSlides - 1);
    nextBtn.classList.toggle("bg-slate-300", activeCarousel.currentSlide === activeCarousel.totalSlides - 1);
  }

  prevBtn.addEventListener("click", () => {
    if (activeCarousel.currentSlide > 0) {
      activeCarousel.currentSlide--;
      updateCarousel();
    }
  });

  nextBtn.addEventListener("click", () => {
    if (activeCarousel.currentSlide < activeCarousel.totalSlides - 1) {
      activeCarousel.currentSlide++;
      updateCarousel();
    }
  });

  updateCarousel(); // Initialize the state
}

// Single global listener outside of initializeCarousel:
document.addEventListener("keydown", (e) => {
  if (!activeCarousel) return;
  if (e.key === "ArrowLeft" && activeCarousel.currentSlide > 0) {
    activeCarousel.currentSlide--;
  } else if (e.key === "ArrowRight" && activeCarousel.currentSlide < activeCarousel.totalSlides - 1) {
    activeCarousel.currentSlide++;
  } else {
    return;
  }
  activeCarousel.carouselContainer.style.transform = `translateX(-${activeCarousel.currentSlide * 100}%)`;
});


//after DOM loaded
document.addEventListener("keydown", function(e) {
  if (e.key === "ArrowUp" || e.key === "ArrowDown") {
    e.preventDefault();
  }
});

  

let activeReadMoreCleanup = null;
let activeGoBackCleanup = null;


function setupReadMoreListener(postEl) {
  // Clean up previous listener if exists
  if (activeReadMoreCleanup) {
    activeReadMoreCleanup(); // remove old listener
    activeReadMoreCleanup = null;
  }

  const readMoreLink = postEl.querySelector(".read-more-link");
  const imageContainer = postEl.querySelector(".image-container");
  const carousel = postEl.querySelector(".carousel-preview");
  const bottom = document.getElementById("bottom-7.5vh");
  const previewContent = postEl.querySelector(".just-a-wrapper");

  if (!readMoreLink || !imageContainer || !carousel || !previewContent) return;

  const onClick = (e) => {
    e.preventDefault();

    imageContainer.classList.add(
      "max-sm:top-[-17.5vh]", "max-md:top-[-22.5vh]",
      "md:top-[-22vh]", "xl:top-[-24.5vh]","w-screen", "!h-[50vh]", "z-30", "bg-black"
    );

    carousel.classList.remove("max-sm:top-[60vh]", "md:top-[63.5vh]");
    carousel.classList.add(
      "max-sm:top-[32.5vh]", "sm:top-[27.5vh]", "md:top-[28vh]","xl:top-[25.5vh]", "w-screen",
      "!h-[42.5vh]", "z-30"
    );

    previewContent.classList.add("hidden");

    const fullCarouselHtml = `<div id="info-carousel" class="w-full h-full relative overflow-hidden transition-all duration-700 ease-in-out opacity-0">
                    <div id="carousel-container" class="w-full h-full flex transition-transform duration-500 ease-in-out ">
                      <div id="first-slide" class="carousel-slide min-w-full max-h-full px-6 flex flex-col bg-green-300">
                        <div id="slide1-content" class="min-h-[18vh] max-h-full"> <!--min-h-[18vh]-> 3.5*3+7.5 to leave space for 3 lines and heading at least-->
                          <div class="font-bold h-[7.5vh]  text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>Slide 1 Title</span></div>
                          <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">Lorem  Lorem ipsum dolor sit sit amet,Loremamet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amdolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet,Lorem ipsum dolor sit amet, </p>
                        </div>
                        <div class="flex-auto bg-black"></div> 
                      </div>
                
                      <div id="second-slide" class="carousel-slide min-w-full max-h-full px-6 flex flex-col bg-slate-300">
                        <div id="slide2-content" class="min-h-[18vh] max-h-full"> 
                          <div class="font-bold h-[7.5vh]  text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>Slide 2 Title</span></div>
                          <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">Lorem  Lorem ipsum dolor sit sit amet,Loremamet,Lorem ipsum dolor </p>
                        </div>
                        <div class="flex-auto bg-black"></div> 
                      </div>
                
                      <div id="third-slide" class="carousel-slide min-w-full max-h-full px-6 flex flex-col bg-slate-300">
                        <div id="slide3-content" class="min-h-[18vh] max-h-full">
                          <div class="font-bold h-[7.5vh]  text-[clamp(.5rem,1.25rem,7vh)] flex justify-center items-center"><span>Slide 3 Title</span></div>
                          <p class="text-gray-700 max-h-[35vh] overflow-y-auto text-[clamp(.5rem,1rem,3.5vh)] leading-[3.5vh]">Lorem  Lorem ipsum dolor sit sit amet,Loremamet,Lorem Lorem ipsum dolor sit sit amet,Loremamet,Lorem Lorem ipsum dolor sit sit amet,Loremamet,Lorem  Lorem ipsum dolor sit sit amet,Loremamet,Lorem </p>
                        </div>
                        <div class="flex-auto bg-black"></div> 
                      </div>
                  </div>
                  <button id="prev-slide" class="absolute h-[5vh] left-2 top-[2.5vh] transform -translate-y-1/2 bg-slate-300 text-white  rounded-full focus:outline-none">‚Üê</button>
                  <button id="next-slide" class="absolute h-[5vh] right-2 top-[2.5vh] transform -translate-y-1/2 bg-slate-400 text-white  rounded-full focus:outline-none">‚Üí</button>
                </div>`;

                const full_carousel_wrapper = document.createElement("div");
      full_carousel_wrapper.innerHTML = fullCarouselHtml.trim();

      const fullCarouselEl = full_carousel_wrapper.firstChild; // ‚úÖ store firstChild before appending
      carousel.appendChild(fullCarouselEl);

      requestAnimationFrame(() => {
        fullCarouselEl.classList.replace("opacity-0", "opacity-100"); // ‚úÖ now this won‚Äôt be null
      });


    // Show bottom bar
    bottom.classList.remove("hidden");
    requestAnimationFrame(() => {
      bottom.classList.replace("opacity-0", "opacity-100");
    });



setTimeout(() => {
  const goBackBtn = document.getElementById("go-back");
  if (goBackBtn) {
    if (activeGoBackCleanup) {
  activeGoBackCleanup();
  activeGoBackCleanup = null;
}
    // ‚úÖ Define handler first
    const goBackHandler = () => {
      // Revert image container classes
      imageContainer.classList.remove(
        "xl:w-full", "max-sm:top-[-17.5vh]", "max-md:top-[-22.5vh]",
        "md:top-[-22vh]", "xl:top-[-24.5vh]", "w-screen", "!h-[50vh]", "bg-black"
      );

      setTimeout(() => imageContainer.classList.remove("z-30"),700);//removed it later to lay over the header while animating back
      

      // Revert carousel preview
      carousel.classList.add("max-sm:top-[60vh]", "md:top-[63.5vh]");
      carousel.classList.remove(
        "max-sm:top-[32.5vh]", "sm:top-[27.5vh]", "md:top-[28vh]",
        "xl:top-[25.5vh]", "w-screen", "!h-[42.5vh]", "z-30"
      );

      previewContent.classList.remove("hidden");

      const infoCarousel = document.getElementById("info-carousel");
      if (infoCarousel) infoCarousel.remove();

      bottom.classList.replace("opacity-100", "opacity-0");
      setTimeout(() => bottom.classList.add("hidden"), 700);

      // üßº Clean up the event listener
      goBackBtn.removeEventListener("click", goBackHandler);
      activeGoBackCleanup = null;
    };

    // üß† Clean up previous listener if exists
    if (activeGoBackCleanup) {
      activeGoBackCleanup();
      activeGoBackCleanup = null;
    }

    // ‚úÖ Attach and store cleanup
    goBackBtn.addEventListener("click", goBackHandler);
    activeGoBackCleanup = () => {
      goBackBtn.removeEventListener("click", goBackHandler);
    };
  }
}, 1000);


  };

  readMoreLink.addEventListener("click", onClick);

  // Set up cleanup to remove this listener later
  activeReadMoreCleanup = () => {
    readMoreLink.removeEventListener("click", onClick);
    activeReadMoreCleanup = null;
  };
}


</script>

</html>
